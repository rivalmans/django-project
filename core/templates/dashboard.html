{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">üìà –í–∞—à —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –¥–∞—à–±–æ—Ä–¥</h2>

<div class="mb-4 d-flex flex-wrap gap-2">
  <a href="{% url 'transaction_list' %}" class="btn btn-primary">+ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è</a>
  <a href="{% url 'category_list' %}" class="btn btn-outline-secondary">+ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è</a>
  <a href="{% url 'budget_list' %}" class="btn btn-outline-primary">üíº –ë—é–¥–∂–µ—Ç–∏</a>
</div>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-3">
    {{ form.start_date.label_tag }} {{ form.start_date }}
  </div>
  <div class="col-md-3">
    {{ form.end_date.label_tag }} {{ form.end_date }}
  </div>
  <div class="col-auto align-self-end">
    <button type="submit" class="btn btn-success">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
  </div>
</form>

<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h5 class="card-title">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</h5>
        <h2>${{ income }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card text-white bg-danger">
      <div class="card-body">
        <h5 class="card-title">–ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</h5>
        <h2>${{ expenses }}</h2>
      </div>
    </div>
  </div>
</div>

<h4 class="mb-3">üìä –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h4>
<canvas id="categoryChart" height="100"></canvas>

<h4 class="mt-5 mb-3">üßæ –û—Å—Ç–∞–Ω–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</h4>
<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
        <th>–¢–∏–ø</th>
        <th>–°—É–º–∞</th>
        <th>–û–ø–∏—Å / –î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions|slice:":5" %}
      <tr>
        <td>{{ tx.date }}</td>
        <td>{{ tx.category.name }}</td>
        <td>{{ tx.transaction_type }}</td>
        <td>${{ tx.amount }}</td>
        <td>
          {{ tx.description }}
          <div class="mt-2">
            <a href="{% url 'edit_transaction' tx.id %}" class="btn btn-sm btn-outline-secondary">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
            <form action="{% url 'delete_transaction' tx.id %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h4 class="mt-5 mb-3">üìâ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±—é–¥–∂–µ—Ç—É</h4>
<div class="table-responsive">
  <table class="table table-hover table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
        <th>–í–∏—Ç—Ä–∞—á–µ–Ω–æ</th>
        <th>–õ—ñ–º—ñ—Ç</th>
        <th>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ %</th>
        <th>–ë—é–¥–∂–µ—Ç</th>
      </tr>
    </thead>
    <tbody>
      {% for cat in category_data|slice:":5" %}
      <tr class="{% if cat.over_budget %}table-danger{% endif %}">
        <td>{{ cat.name }}</td>
        <td>${{ cat.spent }}</td>
        <td>{% if cat.limit %}${{ cat.limit }}{% else %}‚Äî{% endif %}</td>
        <td>{% if cat.percent_used %}{{ cat.percent_used }}%{% else %}‚Äî{% endif %}</td>
        <td>
          {% for b in budgets %}
            {% if b.category.name == cat.name %}
              <a href="{% url 'budget_edit' b.id %}" class="btn btn-sm btn-outline-secondary">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
              <form action="{% url 'delete_budget' b.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
              </form>
            {% endif %}
          {% endfor %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="text-center">–ë—é–¥–∂–µ—Ç–∏ –Ω–µ –∑–∞–¥–∞–Ω—ñ</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const data = {
    labels: [{% for cat in category_data %}'{{ cat.name }}',{% endfor %}],
    datasets: [
      {
        label: '–í–∏—Ç—Ä–∞—Ç–∏',
        data: [{% for cat in category_data %}{{ cat.spent }},{% endfor %}],
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
      },
      {
        label: '–ë—é–¥–∂–µ—Ç',
        data: [{% for cat in category_data %}{{ cat.limit|default:"0" }},{% endfor %}],
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
      }
    ]
  };
  const myChart = new Chart(ctx, {
    type: 'bar',
    data: data,
  });
</script>
{% endblock %}





